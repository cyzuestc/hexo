<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 2017.11.2 mybatis学习 · 陈昀钊</title><meta name="description" content="2017.11.2 mybatis学习 - 陈昀钊"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yzchen.com/atom.xml" title="陈昀钊"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">LASTEST</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ALL</a></li><li class="nav-list-item"><a href="https://www.uestc.edu.cn/" target="_blank" class="nav-list-link">UNIVERSITY</a></li><li class="nav-list-item"><a href="https://github.com/cyzuestc" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://bbs.uestc.edu.cn/" target="_blank" class="nav-list-link">BBS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">2017.11.2 mybatis学习</h1><div class="post-info">Nov 2, 2017</div><div class="post-content"><p>Hibernate与mybatis区别<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hibernate,将整个过程面向对象开发,orm.</span><br><span class="line">ibatis,维持原有的编程方式,前部分面向对象,持久层使用sql语句,面向过程</span><br><span class="line">1.底层使用sql,将hql转sql 无法优化</span><br><span class="line">2.Hibernate通过反射,性能低</span><br><span class="line">3.ibatis基于jdbc的轻量级封装,还是使用sql</span><br></pre></td></tr></table></figure></p>
<p>What is MyBatis?<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Hibernate:po对象, 映射文件 User.hbm.xml(写表和实体对象的属性之间关系,对象之间的关系) 核心配置文件hibernate.cfg.xml,SessionFactory(session)</span><br><span class="line"></span><br><span class="line">Mybatis:po对象,映射文件(UserMapper.xml,写CRUD等SQL语句),对象之间的关系,只有(一,多),核心配置文件(sqlMapConfig.xml),SqlSessionFactory (SqlSession)</span><br></pre></td></tr></table></figure></p>
<p>PersonMapper.xml建立映射，位置和名称可以变<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;cn.itcast.mapper.PersonMapper&quot;&gt;</span><br><span class="line">    &lt;select id=&quot;find&quot; resultType=&quot;cn.itcast.domain.Person&quot;&gt;</span><br><span class="line">        SELECT * FROM person</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="SqlSessionFactory是线程安全的-SqlSession是线程不安全的"><a href="#SqlSessionFactory是线程安全的-SqlSession是线程不安全的" class="headerlink" title="SqlSessionFactory是线程安全的,SqlSession是线程不安全的"></a>SqlSessionFactory是线程安全的,SqlSession是线程不安全的</h3><p>sqlMapConfig.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;environments default=&quot;test&quot;&gt;</span><br><span class="line">        &lt;environment id=&quot;test&quot;&gt;</span><br><span class="line">            &lt;!--事务:JDBC/MANAGED 自己管理区(交给容器管理)--&gt;</span><br><span class="line">            &lt;transactionManager type=&quot;JDBC&quot;&gt;&lt;/transactionManager&gt;</span><br><span class="line">            &lt;!--POOLED UNPOOLED JNDI --&gt;</span><br><span class="line">            &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">                &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/mybatisdb?charsetEncoding=utf8&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;password&quot; value=&quot;admin&quot;/&gt;</span><br><span class="line">            &lt;/dataSource&gt;</span><br><span class="line">        &lt;/environment&gt;</span><br><span class="line">        &lt;environment id=&quot;deploy&quot;&gt;</span><br><span class="line">            &lt;!--事务:JDBC/MANAGED 自己管理区(交给容器管理)--&gt;</span><br><span class="line">            &lt;transactionManager type=&quot;JDBC&quot;&gt;&lt;/transactionManager&gt;</span><br><span class="line">            &lt;!--POOLED UNPOOLED JNDI --&gt;</span><br><span class="line">            &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">                &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/mybatisdb?charsetEncoding=utf8&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;password&quot; value=&quot;admin&quot;/&gt;</span><br><span class="line">            &lt;/dataSource&gt;</span><br><span class="line">        &lt;/environment&gt;</span><br><span class="line">    &lt;/environments&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//此处为映射上面的mapper.xml</span><br><span class="line">    &lt;mappers&gt;</span><br><span class="line">        &lt;mapper resource=&quot;cn/itcast/mapper/PersonMapper.xml&quot;&gt;&lt;/mapper&gt;</span><br><span class="line">    &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p>测试:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private SqlSessionFactory factory;</span><br><span class="line"></span><br><span class="line">@Before</span><br><span class="line">public void init() throws IOException &#123;</span><br><span class="line">    String resource = &quot;sqlMapConfig.xml&quot;;</span><br><span class="line">    InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">    factory = new SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void findAll()  throws IOException &#123;</span><br><span class="line">    SqlSession session = factory.openSession();</span><br><span class="line"></span><br><span class="line">    List&lt;Person&gt; personList = session.selectList(&quot;cn.itcast.mapper.PersonMapper.find&quot;);</span><br><span class="line">    System.out.println(personList.size());</span><br><span class="line">    for (int i = 0; i &lt; personList.size(); i++) &#123;</span><br><span class="line">        System.out.println(personList.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Mybatis最强大功能 resultMap<br>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void testInsert()&#123;</span><br><span class="line">    SqlSession session = factory.openSession();</span><br><span class="line">    Person p = new Person();</span><br><span class="line">    p.setAge(13);</span><br><span class="line">    p.setId(5);</span><br><span class="line">    p.setName(&quot;dasdas&quot;);</span><br><span class="line">    p.setRemark(&quot;chengdu&quot;);</span><br><span class="line">    session.insert(&quot;cn.itcast.mapper.PersonMapper.insert&quot;,p);</span><br><span class="line">    session.commit();</span><br><span class="line">    System.out.println(&quot;finish&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=&quot;insert&quot; parameterType=&quot;cn.itcast.domain.Person&quot;&gt;</span><br><span class="line">    insert into person</span><br><span class="line">    (id,user_name,age,remark)</span><br><span class="line">    VALUES</span><br><span class="line">    (#&#123;id&#125;,#&#123;name&#125;,#&#123;age&#125;,#&#123;remark&#125;)</span><br><span class="line">    &lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<p>简化方法:<br>1.sql片段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--SQL片段--&gt;</span><br><span class="line">&lt;sql id=&quot;cols&quot;&gt;id,user_name,age,remark&lt;/sql&gt;</span><br></pre></td></tr></table></figure></p>
<p>使用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;find&quot; resultMap=&quot;personRM&quot;&gt;</span><br><span class="line">    SELECT &lt;include refid=&quot;cols&quot;/&gt; FROM person</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>2.在sqlMapConfig.xml中,配置typeAliases<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeAliases&gt;</span><br><span class="line">    &lt;typeAlias type=&quot;cn.itcast.domain.Person&quot; alias=&quot;Person&quot;&gt;&lt;/typeAlias&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br></pre></td></tr></table></figure></p>
<p>在personMapper.xml中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insert&quot; parameterType=&quot;Person&quot;&gt;</span><br><span class="line">    insert into person</span><br><span class="line">    (id,user_name,age,remark)</span><br><span class="line">    VALUES</span><br><span class="line">    (#&#123;id&#125;,#&#123;name&#125;,#&#123;age&#125;,#&#123;remark&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<p>动态SQL语句(拼组合查询条件)<br>传参:map和po对象实体,查询条件封装<br>where 条件,能够自动去除and<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;find&quot; parameterType=&quot;map&quot; resultMap=&quot;personRM&quot;&gt;</span><br><span class="line">    SELECT &lt;include refid=&quot;cols&quot;/&gt; from person</span><br><span class="line">   &lt;where&gt;</span><br><span class="line">    &lt;if test=&quot;name!= null&quot;/&gt; and user_name like #&#123;name&#125;</span><br><span class="line">    &lt;if test=&quot;age!= null&quot;/&gt;and age=#&#123;age&#125;</span><br><span class="line">    &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void testFind()&#123;</span><br><span class="line">    SqlSession session = factory.openSession();</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Object&gt; paramap = new HashMap&lt;&gt;();</span><br><span class="line">    paramap.put(&quot;name&quot;,&quot;t%&quot;);</span><br><span class="line">    paramap.put(&quot;age&quot;,30);</span><br><span class="line">    List&lt;Person&gt; list = session.selectList(&quot;cn.itcast.mapper.PersonMapper.find&quot;,paramap);</span><br><span class="line">    System.out.println(list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的,还有set标签,能够自动去除逗号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;set&gt;</span><br><span class="line">    &lt;if test=&quot;name!=null&quot;&gt;user_name=#&#123;name&#125;,&lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;age!=null&quot;&gt;user_age=#&#123;age&#125;,&lt;/if&gt;</span><br><span class="line">&lt;/set&gt;</span><br></pre></td></tr></table></figure></p>
<p>还有foreach标签:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;delete id=&quot;deleteArray&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">    delete from person</span><br><span class="line">    WHERE id IN</span><br><span class="line">    (</span><br><span class="line">    &lt;foreach collection=&quot;array&quot; item=&quot;id&quot; separator=&quot;,&quot;&gt;</span><br><span class="line">        #&#123;id&#125;</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">    )</span><br><span class="line">&lt;/delete&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void testDelateArray()&#123;</span><br><span class="line">    SqlSession session = factory.openSession();</span><br><span class="line">    int[] array = &#123;1,2&#125;;</span><br><span class="line">    session.delete(&quot;cn.itcast.mapper.PersonMapper.deleteArray&quot;,array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>特殊字符:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">and age&lt;=</span><br><span class="line">写为:</span><br><span class="line">&lt;![CDATA[and age &lt;=]]&gt;</span><br></pre></td></tr></table></figure></p>
<p>面向对象:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">需求:人员可以有扩展信息</span><br><span class="line">扩展person_info拓展用户的信息,例如</span><br><span class="line">人员和扩展信息表</span><br><span class="line">对一,对多</span><br><span class="line"></span><br><span class="line">对一:</span><br><span class="line">结果集中有重名字段</span><br><span class="line">&lt;mapper namespace=&quot;cn.itcast.mapper.PersonInfoMapper&quot;&gt;</span><br><span class="line">    &lt;resultMap id=&quot;personInfoRM&quot; type=&quot;cn.itcast.domain.PersonInfo&quot;&gt;</span><br><span class="line">    &lt;id property=&quot;id&quot; column=&quot;ID&quot;/&gt;</span><br><span class="line">    &lt;result property=&quot;name&quot; column=&quot;USER_NAME&quot;/&gt;</span><br><span class="line">    &lt;result property=&quot;age&quot; column=&quot;AGE&quot;/&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;resultMap id=&quot;personPersonInfoRM&quot; type=&quot;cn.itcast.domain.Person&quot; extends=&quot;personInfoRM&quot;&gt;</span><br><span class="line">        &lt;association property=&quot;personInfo&quot; javaType=&quot;cn.itcast.domain.PersonInfo&quot;&gt;</span><br><span class="line">        &lt;result property=&quot;id&quot; column=&quot;INFOID&quot;/&gt;</span><br><span class="line">        &lt;result property=&quot;station&quot; column=&quot;STATION&quot;/&gt;</span><br><span class="line">        &lt;result property=&quot;joinDate&quot; column=&quot;JOIN_DATE&quot;/&gt;</span><br><span class="line">        &lt;association/&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    &lt;select id=&quot;findPersonInfo&quot; parameterType=&quot;map&quot; resultMap=&quot;personPersonInfoRM&quot;&gt;</span><br><span class="line">SELECT</span><br><span class="line">        p.id,p.user_name,p.age,p.remark,</span><br><span class="line">        i.id AS infoid,i.station,i.join_date</span><br><span class="line">FROM</span><br><span class="line">        (SELECT id,user_name,age,remark FROM person) p</span><br><span class="line">        LEFT JOIN</span><br><span class="line">        (SELECT id,station,join_date FROM person_info) i</span><br><span class="line">        ON p.id=i.id</span><br><span class="line">&lt;where&gt;</span><br><span class="line">    &lt;if test=&quot;name!=null&quot;&gt;user_name=#&#123;name&#125;&lt;/if&gt;</span><br><span class="line">&lt;/where&gt;</span><br><span class="line">    &lt;/select&gt;</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/11/18/css学习/" class="prev">PREV</a><a href="/2017/11/02/2017-11-3-mybatis学习/" class="next">NEXT</a></div><div class="copyright"><p>© 2018 powered by <a href="https://github.com/cyzuestc" target="_blank">Chenyunzhao</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>